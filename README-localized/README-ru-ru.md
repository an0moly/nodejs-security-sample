---
page_type: sample
products:
- ms-graph
languages:
- nodejs
- javascript
- html
extensions:
  contentType: samples
  technologies:
  - Microsoft Graph
  - Microsoft identity platform
  services:
  - Microsoft identity platform 
  - Security
  createdDate: 6/7/2018 1:14:00 PM
---
﻿# Пример программы, подключающейся с использованием Microsoft Graph Security API, для Node.js

## Содержание

* [Введение](#introduction)
* [Предварительные требования](#prerequisites)
* [Регистрация приложения](#register-the-application)
* [Сборка и запуск примера](#build-and-run-the-sample)
* [Вопросы и комментарии](#questions-and-comments)
* [Участие](#contributing)
* [Дополнительные ресурсы](#additional-resources)

## Введение

В этом примере показано, как подключить приложение Node.js к рабочей или учебной (Azure Active Directory) либо личной учетной записи Майкрософт с помощью API Microsoft Graph и [пакета SDK JavaScript Graph](https://github.com/microsoftgraph/msgraph-sdk-javascript), чтобы получать и обновлять оповещения системы безопасности.

![Снимок экрана: пример программы, подключающейся с использованием Microsoft Graph, для Node.js](readme-images/Webapp.PNG)

## Необходимые компоненты

Чтобы использовать пример программы, подключающейся с помощью Microsoft Graph, для Node.js, потребуется следующее:

* [Node.js](https://nodejs.org/) (версия 7.6.0\. или более поздняя)

* [Учетная запись Майкрософт](https://www.outlook.com/) или [рабочая либо учебная учетная запись](http://dev.office.com/devprogram)

* [Ngrok](https://ngrok.com/download) для уведомлений веб-перехватчиков.

## Регистрация приложения

Чтобы настроить пример, необходимо зарегистрировать новое приложение на [портале регистрации приложений](https://go.microsoft.com/fwlink/?linkid=2083908) Майкрософт.

Чтобы зарегистрировать новое приложение, выполните следующие действия:

1. Войдите на [портал регистрации приложений Azure](https://go.microsoft.com/fwlink/?linkid=2083908) с помощью личной, рабочей или учебной учетной записи. 

2. Выберите **Новая регистрация**. Введите URI перенаправления *http://localhost:3000/token*.

3. Введите имя приложения и нажмите кнопку **Зарегистрировать**.
    > **Примечание.** Если вы хотите, чтобы приложение было мультитенантным, в разделе **Поддерживаемые типы учетных записей** выберите `Учетные записи в любом каталоге организации`.

4. Затем вы увидите страницу обзора для вашего приложения. Скопируйте и сохраните **Идентификатор приложения**. Он потребуется позже для завершения процесса настройки.

5. В разделе **Сертификаты и секреты** выберите **Новый секрет клиента** и добавьте краткое описание. Новый секрет будет отображаться в столбце **Значение**. Скопируйте пароль. Он потребуется позже для завершения процесса настройки.

6. В разделе **Разрешения API** выберите **Добавить разрешение** > **Microsoft Graph**.

7. В разделе **Делегированные разрешения** добавьте необходимые разрешения или области для примера. Для этого примера требуются разрешения **User.Read.All**, **SecurityEvents.ReadWrite.All** и **SecurityActions.ReadWrite.All**.
    >**Примечание**. Дополнительные сведения о модели разрешений Graph см. в [справочнике по разрешениям Microsoft Graph](https://developer.microsoft.com/en-us/graph/docs/concepts/permissions_reference).

## Предоставление согласия администратора на просмотр данных безопасности

### Назначение области (разрешения)

1. Предоставьте администратору **идентификатор приложения** и **URI перенаправления**, примененные на предыдущих шагах. Администратор клиента Azure Active Directory должен предоставить приложению необходимое согласие (разрешения).
2. Как администратор клиента для организации откройте окно браузера и вставьте в адресную строку указанный ниже URL-адрес
(после добавления значений для APPLICATION\_ID и REDIRECT\_URL): https://login.microsoftonline.com/common/adminconsent?client\_id=APPLICATION\_ID&state=12345&redirect\_uri=REDIRECT\_URL.
3. После проверки подлинности администратор клиента увидит диалоговое окно, аналогичное следующему (в зависимости от разрешений, запрашиваемых приложением):

     ![Диалоговое окно подтверждения области](readme-images/Scope.PNG)

3. Нажав кнопку "Принять" в этом окне, администратор клиента даст согласие на использование этого приложения всем пользователям в организации. Примечание.
Так как в настоящий момент по URL-адресу переадресации приложение не выполняется, появится сообщение об ошибке. Такое поведение является ожидаемым. К тому времени, когда появится эта страница ошибки, согласие администратора клиента уже будет предоставлено.

    ![Диалоговое окно подтверждения области](readme-images/GrantError.png)

### Авторизация пользователей в организации для доступа к Microsoft Graph Security API (назначение необходимой роли Azure)

Для доступа к данным безопасности с помощью Microsoft Graph Security API клиентскому приложению следует предоставить необходимые разрешения. При работе в режиме делегированного доступа пользователю, выполнившему вход в приложение, также необходимо иметь право на вызов Microsoft Graph Security API.</br>
В этом разделе объясняется, как администратор клиента может авторизовать определенных пользователей в организации.

1. Как администратор клиента войдите на [портал Azure](https://portal.azure.com).

2. Перейдите к колонке Azure Active Directory.

3. Выберите **Пользователи**.

4. Выберите учетную запись пользователя, которому нужно предоставить доступ к Microsoft Graph Security API.

5. Выберите **Роль каталога**.

6. Выберите переключатель **Администратор с ограниченными правами** и установите флажок рядом с ролью **Администратор безопасности**

     ![Диалоговое окно подтверждения роли](readme-images/SecurityRole.png)

7. Нажмите кнопку **Сохранить** в верхней части страницы

Повторите это действие для всех пользователей в организации, которые уполномочены использовать приложения, вызывающие Microsoft Graph Security API. В настоящее время это разрешение не может быть предоставлено группам безопасности.

> **Примечание.** Дополнительные сведения о потоке авторизации см. в статье [Авторизация и Microsoft Graph Security API](https://developer.microsoft.com/en-us/graph/docs/concepts/security-authorization). 

## Настройка веб-перехватчиков

1. Скачайте [ngrok](https://ngrok.com/download).
2. Следуйте инструкциям по установке на веб-сайте ngrok.
3. Запустите ngrok, если используется Windows. Выполните команду "ngrok.exe http 3000", чтобы запустить ngrok и открыть туннель к порту 3000 localhost.
4. Затем обновите файл `config.js`, используя URL-адрес ngrok.

    ![Ngrok](readme-images/Ngrok.PNG)

## Сборка и запуск примера

1. Скачайте или клонируйте пример приложения, подключающегося с использованием Microsoft Graph, для Node.js.

2. Используя свою любимую среду IDE, откройте **configs.js**.

3. Замените заполнители **clientId** и **clientSecret** на идентификатор приложения и пароль, которые вы скопировали при регистрации приложения. Замените **notificationUrl** на URL-адрес пересылки ngrok.

4. В командной строке выполните следующую команду в корневом каталоге. При этом устанавливаются зависимости проекта.

  ```npm install```

 > **Примечание.**
 Если на вашем компьютере не установлен Python 2.7, в процессе выполнения может возникнуть ошибка. При возникновении ошибки веб-приложение продолжает работать.

5. Выполните следующую команду, чтобы запустить сервер разработки.

  ```node app.js```

6. Введите адрес `http://localhost:3000/` в веб-браузере.

7. Нажмите кнопку **Войти с помощью учетной записи Майкрософт**.

8. Войдите с помощью личной, рабочей или учебной учетной записи и предоставьте необходимые разрешения.

9. Выберите оповещения для просмотра, указав условия фильтрации, и нажмите кнопку **Получить оповещения**.
По завершении операции на странице будут отображаться оповещения, соответствующие условиям фильтрации. Также отображаются запрос SDK и запрос REST, которые используются для совершения вызова. При нажатии ссылки "Запрос REST" откроется новая вкладка **Песочница Graph** с предварительно созданным запросом.
    >**Примечание.** Приложение получает от клиента оповещения системы безопасности, соответствующие условиям фильтрации. Если соответствующие оповещения системы безопасности от перечисленных поставщиков отсутствуют, в разделе "Ответ" будет отображаться сообщение "Нет соответствующих оповещений". Чтобы создать примеры оповещений Центра безопасности Azure, см. статью [Проверка оповещений Центра безопасности](https://docs.microsoft.com/en-us/azure/security-center/security-center-alert-validation)

10. В списке соответствующих оповещений нажмите **Заголовок** оповещения, которое вы хотите просмотреть. Подробные сведения об оповещении (JSON) отобразятся на вкладке **Сведения об оповещении** в правой части веб-страницы. Если оповещение содержит свойства **имя участника-пользователя** или **полное доменное имя**, приложение совершит дополнительный вызов Azure Active Directory с помощью API Microsoft Graph, чтобы получить дополнительные сведения об учетной записи пользователя и устройстве. Выберите вкладку **Сведения о пользователе и устройстве**, чтобы просмотреть дополнительные данные о пользователе и устройстве (если они существуют).
11. Чтобы обновить оповещение, введите его идентификатор, а затем выберите или введите значения для редактируемых свойств и нажмите кнопку **Обновить оповещение**. **Сведения об исходном оповещении** и **Обновленные сведения об оповещении** отображаются на вкладке **Управление оповещениями** в правой части веб-страницы.
12. Чтобы создать подписку на веб-перехватчик, выберите по крайней мере одно свойство в любом раскрывающемся списке или введите FQDN либо UPN. Затем нажмите кнопку "Подписаться", при этом будет создана подписка на веб-перехватчик. Затем щелкните "Уведомить", чтобы открыть другую страницу, на которой будут отображаться уведомления веб-перехватчика. При обновлении свойства, соответствующего ресурсу подписки на веб-перехватчик, уведомление отправляется в приложение и отображается на странице уведомлений.
    >**Примечание.** При запуске примера на локальном компьютере следует использовать [ngrok](#Webhook-setup) для создания и получения уведомлений.

## Вопросы и комментарии

Мы будем рады получить ваш отзыв о примере программы, подключающейся с использованием Microsoft Graph Security API и пакета SDK JavaScript Graph, для Node.js Вы можете отправлять нам свои вопросы и предложения с помощью вкладки [Проблемы](https://github.com/microsoftgraph/nodejs-connect-sample/issues) этого репозитория.

Общие вопросы относительно разработки решений для Microsoft Graph следует задавать на сайте [Microsoft TechCommunity](https://aka.ms/securitygraphcommunity) или [Stack Overflow](http://stackoverflow.com/questions/tagged/microsoft-graph-security). На сайте **Stack Overflow** обязательно помечайте свои вопросы и комментарии тегом \[microsoft-graph-security].

## Участие ##

Это открытые источники, выпущенные в разделе [Лицензия MIT](https://github.com/microsoftgraph/nodejs-security-sample/blob/master/LICENSE). Вопросы (включая запросы на добавление функций или вопросы о данном примере) и [запросы на вытягивание](https://github.com/microsoftgraph/nodejs-security-sample/pulls) приветствуются. Если вы хотели бы видеть другой пример использования Microsoft Graph Security API, мы будем рады узнать об этом. Укажите [проблему](https://github.com/microsoftgraph/nodejs-security-sample/issues) и дайте нам знать!

Этот проект соответствует [Правилам поведения разработчиков открытого кода Майкрософт](https://opensource.microsoft.com/codeofconduct/). Дополнительные сведения см. в разделе [вопросов и ответов о правилах поведения](https://opensource.microsoft.com/codeofconduct/faq/). Если у вас возникли вопросы или замечания, напишите нам по адресу [opencode@microsoft.com](mailto:opencode@microsoft.com).
  
## Дополнительные ресурсы

- [Документация по Microsoft Graph Security API](https://aka.ms/securitygraphdocs)
- [API авторизации и безопасности в Microsoft Graph](https://developer.microsoft.com/en-us/graph/docs/concepts/security-authorization)
- [Другие примеры приложений, подключающихся с использованием Microsoft Graph](https://github.com/MicrosoftGraph?utf8=%E2%9C%93&query=-Connect)
- [Microsoft Graph](http://graph.microsoft.io)

## Авторские права
(c) Корпорация Майкрософт (Microsoft Corporation), 2018. Все права защищены.
